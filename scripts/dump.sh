#!/bin/bash

cp /var/run/ltfsdm/OpenLTFS.db /var/run/ltfsdm/OpenLTFS.db.cpy

sqlite3 /var/run/ltfsdm/OpenLTFS.db.cpy <<EOF
.mode column
.width 0 32
.headers on

CREATE TABLE OPTYPE(VALUE INT NOT NULL, OPERATION CHAR(256) NOT NULL);
INSERT INTO "OPTYPE" VALUES(0,'transparent recall');
INSERT INTO "OPTYPE" VALUES(1,'selective recall');
INSERT INTO "OPTYPE" VALUES(2,'migration');

CREATE TABLE REQSTATETYPE(VALUE INT NOT NULL, REQSTATE CHAR(256) NOT NULL);
INSERT INTO "REQSTATETYPE" VALUES(0,'new');
INSERT INTO "REQSTATETYPE" VALUES(1,'in progress');
INSERT INTO "REQSTATETYPE" VALUES(2,'completed');
INSERT INTO "REQSTATETYPE" VALUES(3,'failed');

CREATE TABLE FILESTATETYPE(VALUE INT NOT NULL, FILESTATE CHAR(256) NOT NULL);
INSERT INTO "FILESTATETYPE" VALUES(0,'resident');
INSERT INTO "FILESTATETYPE" VALUES(1,'premigrated');
INSERT INTO "FILESTATETYPE" VALUES(2,'migrated');

CREATE TABLE TARGETSTATETYPE(VALUE INT NOT NULL, TARGETSTATE CHAR(256) NOT NULL);
INSERT INTO "TARGETSTATETYPE" VALUES(0,'premigrated');
INSERT INTO "TARGETSTATETYPE" VALUES(1,'mig/res');

SELECT OPTYPE.OPERATION,  -- <-
       FILE_NAME,
       REQ_NUM,
       TARGETSTATETYPE.TARGETSTATE,  -- <-
       REPL_NUM,
       COLOC_GRP,
       FILE_SIZE,
       FS_ID,
       I_GEN,
       I_NUM,
       MTIME_SEC,
       MTIME_NSEC,
       LAST_UPD,
       TAPE_ID,
       FILESTATETYPE.FILESTATE, -- <-
       START_BLOCK
       FROM JOB_QUEUE JOIN OPTYPE ON JOB_QUEUE.OPERATION=OPTYPE.VALUE
                      JOIN TARGETSTATETYPE ON JOB_QUEUE.TARGET_STATE=TARGETSTATETYPE.VALUE
                      JOIN FILESTATETYPE ON JOB_QUEUE.FILE_STATE=FILESTATETYPE.VALUE;


.print ''

SELECT OPTYPE.OPERATION,  -- <-
       REQ_NUM,
       TARGETSTATETYPE.TARGETSTATE,  -- <-
       NUM_REPL,
       REPL_NUM,
       COLOC_GRP,
       TAPE_ID,
       TIME_ADDED,
       REQSTATETYPE.REQSTATE -- <-
       FROM REQUEST_QUEUE JOIN OPTYPE ON REQUEST_QUEUE.OPERATION=OPTYPE.VALUE
                          JOIN TARGETSTATETYPE ON REQUEST_QUEUE.TARGET_STATE=TARGETSTATETYPE.VALUE
                          JOIN REQSTATETYPE ON REQUEST_QUEUE.STATE=REQSTATETYPE.VALUE;

DROP TABLE OPTYPE;
DROP TABLE REQSTATETYPE;
DROP TABLE FILESTATETYPE;
DROP TABLE TARGETSTATETYPE;

EOF

rm /var/run/ltfsdm/OpenLTFS.db.cpy
